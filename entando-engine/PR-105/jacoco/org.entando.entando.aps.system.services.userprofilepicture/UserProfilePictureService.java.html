<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserProfilePictureService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Entando Core: Engine</a> &gt; <a href="index.source.html" class="el_package">org.entando.entando.aps.system.services.userprofilepicture</a> &gt; <span class="el_source">UserProfilePictureService.java</span></div><h1>UserProfilePictureService.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2018-Present Entando Inc. (http://www.entando.com) All rights reserved.
 *
 * This library is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 *
 * This library is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 */
package org.entando.entando.aps.system.services.userprofilepicture;

import com.agiletec.aps.system.services.user.UserDetails;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.List;
import javax.annotation.PostConstruct;
import javax.swing.ImageIcon;
import org.apache.commons.io.FilenameUtils;
import org.apache.commons.lang3.StringUtils;
import org.entando.entando.aps.system.exception.RestServerError;
import org.entando.entando.aps.system.services.image.DefaultImageResizer;
import org.entando.entando.aps.system.services.image.IImageResizer;
import org.entando.entando.aps.system.services.image.ImageDimension;
import org.entando.entando.aps.system.services.image.PNGImageResizer;
import org.entando.entando.aps.system.services.storage.IStorageManager;
import org.entando.entando.ent.exception.EntException;
import org.entando.entando.web.userprofilepicture.model.UserProfilePictureDto;
import org.entando.entando.web.userprofilepicture.model.UserProfilePictureVersionDto;
import org.springframework.util.Assert;
import org.springframework.web.multipart.MultipartFile;

<span class="fc" id="L40">public class UserProfilePictureService implements IUserProfilePictureService {</span>

    private IUserProfilePictureManager userProfilePictureManager;
    private IStorageManager storageManager;

<span class="fc" id="L45">    private String folder = &quot;profile&quot;;</span>
<span class="fc" id="L46">    private List&lt;ImageDimension&gt; dimensions = createDimensions();</span>
<span class="fc" id="L47">    private PNGImageResizer pngImageResizer = new PNGImageResizer();</span>
<span class="fc" id="L48">    private DefaultImageResizer defaultImageResizer = new DefaultImageResizer();</span>

    @PostConstruct
    public void setup() {
<span class="fc" id="L52">        pngImageResizer.setStorageManager(storageManager);</span>
<span class="fc" id="L53">        defaultImageResizer.setStorageManager(storageManager);</span>
<span class="fc" id="L54">    }</span>


    @Override
    public UserProfilePictureDto getUserProfilePicture(UserDetails user) {
        try {
<span class="fc" id="L60">            UserProfilePicture userProfilePicture = userProfilePictureManager.getUserProfilePicture(user.getUsername());</span>
<span class="fc" id="L61">            return userProfilePictureToDto(userProfilePicture);</span>
<span class="nc" id="L62">        } catch (EntException e) {</span>
<span class="nc" id="L63">            throw new RestServerError(&quot;Error getting user profile picture&quot;, e);</span>
        }
    }

    @Override
    public UserProfilePictureDto addUserProfilePicture(MultipartFile file, UserDetails user) {

        try {
<span class="fc" id="L71">            UserProfilePicture userProfilePicture = createUserProfilePicture(file, user);</span>
<span class="fc" id="L72">            userProfilePictureManager.addUserProfilePicture(userProfilePicture);</span>
<span class="fc" id="L73">            return getUserProfilePicture(user);</span>
<span class="nc" id="L74">        } catch (EntException e) {</span>
<span class="nc" id="L75">            throw new RestServerError(&quot;Error reading file input stream&quot;, e);</span>
        }
    }

    @Override
    public UserProfilePictureDto updateUserProfilePicture(MultipartFile file, UserDetails user) {
        try {
<span class="fc" id="L82">            deleteUserProfilePictureFiles(user);</span>
<span class="fc" id="L83">            UserProfilePicture userProfilePicture = createUserProfilePicture(file, user);</span>
<span class="fc" id="L84">            userProfilePictureManager.updateUserProfilePicture(userProfilePicture);</span>
<span class="fc" id="L85">            return getUserProfilePicture(user);</span>
<span class="nc" id="L86">        } catch (EntException e) {</span>
<span class="nc" id="L87">            throw new RestServerError(&quot;Error updating user profile picture&quot;, e);</span>
        }
    }

    @Override
    public void deleteUserProfilePicture(UserDetails user) {
        try {
<span class="fc" id="L94">            deleteUserProfilePictureFiles(user);</span>
<span class="fc" id="L95">            userProfilePictureManager.deleteUserProfilePicture(user.getUsername());</span>
<span class="nc" id="L96">        } catch (EntException e) {</span>
<span class="nc" id="L97">            throw new RestServerError(&quot;Error updating user profile picture&quot;, e);</span>
<span class="fc" id="L98">        }</span>
<span class="fc" id="L99">    }</span>

    private UserProfilePicture createUserProfilePicture(MultipartFile multipartFile, UserDetails user) {
<span class="fc" id="L102">        UserProfilePicture result = new UserProfilePicture();</span>
<span class="fc" id="L103">        result.setUsername(user.getUsername());</span>

        try {
<span class="fc" id="L106">            UserProfilePictureFile file = new UserProfilePictureFile();</span>

<span class="fc" id="L108">            file.setInputStream(multipartFile.getInputStream());</span>
<span class="fc" id="L109">            file.setFileSize(calculateSize(multipartFile.getBytes().length));</span>
<span class="fc" id="L110">            file.setFileName(multipartFile.getOriginalFilename());</span>
<span class="fc" id="L111">            file.setMimeType(multipartFile.getContentType());</span>
<span class="fc" id="L112">            file.setUser(user);</span>

<span class="fc" id="L114">            String masterImageFileName = getNewInstanceFileName(file.getFileName(), 0, null, user.getUsername());</span>
<span class="fc" id="L115">            String subPath = createVersionPath(masterImageFileName, user.getUsername());</span>
<span class="fc" id="L116">            storageManager.deleteFile(subPath, false);</span>
<span class="fc" id="L117">            File tempMasterFile = this.saveTempFile(masterImageFileName, file.getInputStream());</span>
<span class="fc" id="L118">            file.setFile(tempMasterFile);</span>

<span class="fc" id="L120">            UserProfilePictureVersion version = new UserProfilePictureVersion();</span>
<span class="fc" id="L121">            version.setUsername(result.getUsername());</span>
<span class="fc" id="L122">            version.setPath(createVersionPath(masterImageFileName, user.getUsername()));</span>
<span class="fc" id="L123">            version.setSize(file.getFileSize() + &quot; Kb&quot;);</span>
<span class="fc" id="L124">            result.getVersions().add(version);</span>

<span class="fc" id="L126">            this.saveResizedInstances(result, subPath, file);</span>
<span class="fc" id="L127">            this.storageManager.saveFile(subPath,false, new FileInputStream(tempMasterFile));</span>

<span class="fc" id="L129">            tempMasterFile.delete();</span>
<span class="nc" id="L130">        } catch (IOException | EntException e) {</span>
            //TODO e.printStackTrace();
<span class="fc" id="L132">        }</span>

<span class="fc" id="L134">        return result;</span>
    }

    private int calculateSize(long length) {
<span class="fc" id="L138">        return (int)Math.ceil(length / 1000.0);</span>
    }

    private String getNewInstanceFileName(String masterFileName, int size, String langCode, String username) {
<span class="fc" id="L142">        String baseName = FilenameUtils.getBaseName(masterFileName);</span>
<span class="fc" id="L143">        String extension = FilenameUtils.getExtension(masterFileName);</span>
<span class="fc" id="L144">        String suffix = &quot;&quot;;</span>
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">        if (size &gt;= 0) {</span>
<span class="fc" id="L146">            suffix += &quot;_d&quot; + size;</span>
        }
<span class="pc bpc" id="L148" title="1 of 2 branches missed.">        if (langCode != null) {</span>
<span class="nc" id="L149">            suffix += &quot;_&quot; + langCode;</span>
        }
<span class="fc" id="L151">        return this.createFileName(getMultiFileUniqueBaseName(baseName, suffix, extension, username), extension);</span>
    }

    protected String createFileName(String baseName, String extension) {
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">        return extension == null ? baseName : baseName + '.' + extension;</span>
    }

    protected String getMultiFileUniqueBaseName(String baseName, String suffix, String extension, String username) {
<span class="fc" id="L159">        Assert.hasLength(baseName, &quot;base name of file can't be null or empty&quot;);</span>
<span class="fc" id="L160">        Assert.notNull(suffix, &quot;file suffix can't be null&quot;);</span>
<span class="fc" id="L161">        baseName = this.purgeBaseName(baseName);</span>
<span class="fc" id="L162">        String suggestedName = baseName + suffix;</span>
<span class="fc" id="L163">        int fileOrder = 1;</span>
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">        while(this.exists(this.createFileName(suggestedName, extension), username)) {</span>
<span class="nc" id="L165">            suggestedName = baseName + '_' + fileOrder + suffix;</span>
<span class="nc" id="L166">            fileOrder ++;</span>
        }
<span class="fc" id="L168">        return suggestedName;</span>
    }

    private String purgeBaseName(String baseName) {
<span class="fc" id="L172">        String purgedName = baseName.replaceAll(&quot;[^ _.a-zA-Z0-9]&quot;, &quot;&quot;);</span>
<span class="fc" id="L173">        return purgedName.trim().replace(' ', '_');</span>
    }

    protected boolean exists(String instanceFileName, String username) {
        try {
<span class="fc" id="L178">            String subPath = createVersionPath(instanceFileName, username);</span>
<span class="fc" id="L179">            return storageManager.exists(subPath, false);</span>
<span class="nc" id="L180">        } catch (Throwable t) {</span>
<span class="nc" id="L181">            throw new RuntimeException(&quot;Error testing existing file &quot; + instanceFileName, t);</span>
        }
    }

    protected File saveTempFile(String filename, InputStream is) throws EntException, IOException {
<span class="fc" id="L186">        String tempDir = System.getProperty(&quot;java.io.tmpdir&quot;);</span>
<span class="fc" id="L187">        String filePath = tempDir + File.separator + filename;</span>
<span class="fc" id="L188">        FileOutputStream outStream = null;</span>
        try {
<span class="fc" id="L190">            byte[] buffer = new byte[1024];</span>
            int length;
<span class="fc" id="L192">            outStream = new FileOutputStream(filePath);</span>
<span class="fc bfc" id="L193" title="All 2 branches covered.">            while ((length = is.read(buffer)) != -1) {</span>
<span class="fc" id="L194">                outStream.write(buffer, 0, length);</span>
<span class="fc" id="L195">                outStream.flush();</span>
            }
<span class="nc" id="L197">        } catch (Throwable t) {</span>
<span class="nc" id="L198">            throw new EntException(&quot;Error on saving temporary file&quot;, t);</span>
        } finally {
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">            if (null != outStream) {</span>
<span class="fc" id="L201">                outStream.close();</span>
            }
<span class="pc bpc" id="L203" title="1 of 2 branches missed.">            if (null != is) {</span>
<span class="fc" id="L204">                is.close();</span>
            }
        }
<span class="fc" id="L207">        return new File(filePath);</span>
    }

    private void saveResizedInstances(UserProfilePicture result, String masterFilePath, UserProfilePictureFile file)
            throws EntException {
        try {
<span class="fc bfc" id="L213" title="All 2 branches covered.">            for (ImageDimension dimension : dimensions) {</span>
<span class="fc" id="L214">                UserProfilePictureVersion version = new UserProfilePictureVersion();</span>
<span class="fc" id="L215">                version.setUsername(result.getUsername());</span>
<span class="fc" id="L216">                result.getVersions().add(version);</span>
<span class="fc" id="L217">                ImageIcon imageIcon = new ImageIcon(masterFilePath);</span>
<span class="fc" id="L218">                this.saveResizedImage(file, imageIcon, dimension, version);</span>
<span class="fc" id="L219">            }</span>
<span class="nc" id="L220">        } catch (Throwable t) {</span>
<span class="nc" id="L221">            throw new EntException(&quot;Error saving resized image resource instances&quot;, t);</span>
<span class="fc" id="L222">        }</span>
<span class="fc" id="L223">    }</span>

    private void saveResizedImage(UserProfilePictureFile file, ImageIcon imageIcon, ImageDimension dimension,
            UserProfilePictureVersion version) throws EntException {
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">        if (dimension.getIdDim() == 0) {</span>
<span class="nc" id="L228">            return;</span>
        }

<span class="fc" id="L231">        String imageName = getNewInstanceFileName(file.getFileName(), dimension.getIdDim(), null, file.getUser().getUsername());</span>
<span class="fc" id="L232">        String subPath = createVersionPath(imageName, file.getUser().getUsername());</span>

        try {
<span class="fc" id="L235">            version.setDimensions(String.format(&quot;%dx%d px&quot;, dimension.getDimx(), dimension.getDimy()));</span>
<span class="fc" id="L236">            version.setPath(subPath);</span>
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">            if(file.getMimeType().contains(&quot;svg&quot;)) {</span>
<span class="nc" id="L238">                long realLength = calculateSize(file.getFile().length());</span>
<span class="nc" id="L239">                version.setSize(realLength + &quot; Kb&quot;);</span>
<span class="nc" id="L240">                this.storageManager.saveFile(subPath, false, new FileInputStream(file.getFile()));</span>
<span class="nc" id="L241">            }else {</span>
<span class="fc" id="L242">                storageManager.deleteFile(subPath, false);</span>
<span class="fc" id="L243">                IImageResizer resizer = this.getImageResizer(subPath);</span>
<span class="fc" id="L244">                resizer.saveResizedImage(subPath, false, imageIcon, dimension, version);</span>
            }
<span class="nc" id="L246">        } catch (Throwable t) {</span>
<span class="nc" id="L247">            throw new EntException(&quot;Error creating resource file instance '&quot; + subPath + &quot;'&quot;, t);</span>
<span class="fc" id="L248">        }</span>
<span class="fc" id="L249">    }</span>

    private String createVersionPath(String imageName, String username) {
<span class="fc" id="L252">        return StringUtils.join(storageManager.getResourceUrl(folder, false), &quot;/&quot;, username, &quot;/&quot;, imageName);</span>
    }

    private IImageResizer getImageResizer(String filePath) {
<span class="fc" id="L256">        String extension = FilenameUtils.getExtension(filePath);</span>
<span class="pc bpc" id="L257" title="1 of 2 branches missed.">        if (&quot;png&quot;.equals(extension)) {</span>
<span class="nc" id="L258">            return pngImageResizer;</span>
        } else {
<span class="fc" id="L260">            return defaultImageResizer;</span>
        }
    }

    private void deleteUserProfilePictureFiles(UserDetails user) throws EntException {
<span class="fc" id="L265">        UserProfilePicture userProfilePicture = userProfilePictureManager.getUserProfilePicture(user.getUsername());</span>
<span class="fc bfc" id="L266" title="All 2 branches covered.">        for (UserProfilePictureVersion version : userProfilePicture.getVersions()) {</span>
<span class="fc" id="L267">            storageManager.deleteFile(version.getPath(), false);</span>
<span class="fc" id="L268">        }</span>
<span class="fc" id="L269">    }</span>

    private UserProfilePictureDto userProfilePictureToDto(UserProfilePicture userProfilePicture) {
<span class="fc bfc" id="L272" title="All 2 branches covered.">        if (userProfilePicture != null) {</span>
<span class="fc" id="L273">            UserProfilePictureDto result = new UserProfilePictureDto();</span>
<span class="fc" id="L274">            result.setUsername(userProfilePicture.getUsername());</span>

<span class="fc bfc" id="L276" title="All 2 branches covered.">            for (UserProfilePictureVersion version : userProfilePicture.getVersions()) {</span>
<span class="fc" id="L277">                UserProfilePictureVersionDto versionDto = new UserProfilePictureVersionDto();</span>
<span class="fc" id="L278">                versionDto.setDimensions(version.getDimensions());</span>
<span class="fc" id="L279">                versionDto.setPath(version.getPath());</span>
<span class="fc" id="L280">                versionDto.setSize(version.getSize());</span>
<span class="fc" id="L281">                result.getVersions().add(versionDto);</span>
<span class="fc" id="L282">            }</span>

<span class="fc" id="L284">            return result;</span>
        }
<span class="fc" id="L286">        return null;</span>
    }

    private List&lt;ImageDimension&gt; createDimensions() {
<span class="fc" id="L290">        List&lt;ImageDimension&gt; result = new ArrayList();</span>

<span class="fc" id="L292">        result.add(new ImageDimension(1, 90, 90));</span>
<span class="fc" id="L293">        result.add(new ImageDimension(2, 130, 130));</span>
<span class="fc" id="L294">        result.add(new ImageDimension(3, 150, 150));</span>

<span class="fc" id="L296">        return result;</span>
    }

    public void setUserProfilePictureManager(
            IUserProfilePictureManager userProfilePictureManager) {
<span class="fc" id="L301">        this.userProfilePictureManager = userProfilePictureManager;</span>
<span class="fc" id="L302">    }</span>

    public void setStorageManager(IStorageManager storageManager) {
<span class="fc" id="L305">        this.storageManager = storageManager;</span>
<span class="fc" id="L306">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>